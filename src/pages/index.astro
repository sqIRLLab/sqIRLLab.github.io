---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/Navbar.astro';
import News from '../components/News.astro';
import { getCollection, getEntry } from 'astro:content';

const news = await getCollection('news');
// Sort news by date (newest first)
const sortedNews = news.sort((a, b) => b.data.date.localeCompare(a.data.date));

// Get home page content
const homeContent = await getEntry('home', 'main');
if (!homeContent) {
	throw new Error('Home page content not found. Please create src/content/home/main.json');
}
const { title, subtitle, description, email, logo } = homeContent.data;
---

<BaseLayout title={`${title} - ${subtitle}`}>
	<Navbar currentPage="/" />

	<div class="max-w-[1000px] mx-auto px-4 py-8">
		<div class="card bg-base-100 shadow-lg mb-6">
			<div class="card-body">
				<div class="flex flex-col md:flex-row items-center gap-6">
					<div class="flex-shrink-0 flex flex-col items-center gap-3">
						<img src={logo} alt={`${title} Lab Logo`} class="w-24 h-24 md:w-32 md:h-32 object-contain" />
						<a href={`mailto:${email}`} class="btn btn-primary btn-sm">
							<i class="fas fa-envelope"></i>
							Email
						</a>
					</div>
					<div class="flex-grow text-center md:text-left">
						<h1 class="text-3xl md:text-4xl font-bold mb-2">{title}</h1>
						<p class="text-lg mb-4">{subtitle}</p>
						<div class="prose max-w-none">
							<p class="text-base leading-relaxed">
								{description}
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>

		<h2 class="text-2xl font-bold mb-4">News</h2>
		<div class="flex flex-col gap-3" id="news-container">
			{sortedNews.slice(0, 5).map((item) => (
				<News {...item.data} />
			))}
		</div>
		{sortedNews.length > 5 && (
			<button id="load-more" class="btn btn-outline btn-sm mt-4 mx-auto block">
				Load more
			</button>
		)}
	</div>

	<script is:inline define:vars={{ allNews: sortedNews }}>
		let currentCount = 5;
		const loadMoreBtn = document.getElementById('load-more');
		const newsContainer = document.getElementById('news-container');

		if (loadMoreBtn) {
			loadMoreBtn.addEventListener('click', () => {
				const nextBatch = allNews.slice(currentCount, currentCount + 5);

				nextBatch.forEach(item => {
					const newsElement = document.createElement('div');
					const link = item.data.link;

					// Format date
					const [year, month] = item.data.date.split('/');
					const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
					const formattedDate = `${monthNames[parseInt(month) - 1]} ${year}`;

					// Check for valid link
					const hasValidLink = link && !link.includes('_example') && link !== '';

					if (hasValidLink) {
						newsElement.innerHTML = `
							<a href="${link}" target="_blank" rel="noopener noreferrer" class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow p-4 block">
								<div class="flex items-baseline justify-between gap-4">
									<p class="text-sm font-bold flex-grow min-w-0 truncate">${item.data.description}</p>
									<span class="text-sm opacity-60 whitespace-nowrap">${formattedDate}</span>
								</div>
							</a>
						`;
					} else {
						newsElement.innerHTML = `
							<div class="card bg-base-100 shadow-sm p-4">
								<div class="flex items-baseline justify-between gap-4">
									<p class="text-sm font-bold flex-grow min-w-0 truncate">${item.data.description}</p>
									<span class="text-sm opacity-60 whitespace-nowrap">${formattedDate}</span>
								</div>
							</div>
						`;
					}

					newsContainer.appendChild(newsElement.firstElementChild);
				});

				currentCount += 5;

				if (currentCount >= allNews.length) {
					loadMoreBtn.style.display = 'none';
				}
			});
		}
	</script>
</BaseLayout>
